name: "Schema Truth Verification"

on:
  pull_request:
    paths:
      - "supabase/migrations/**"
      - "types/supabase.ts"
      - "database_schema_audit.md"
  push:
    branches: [ main, develop ]
    paths:
      - "supabase/migrations/**"
      - "types/supabase.ts"
      - "database_schema_audit.md"

jobs:
  verify-schema:
    runs-on: ubuntu-latest
    environment: develop
    env:
      SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
      STRIPE_PRICE_TALENT_MONTHLY: ${{ secrets.STRIPE_PRICE_TALENT_MONTHLY }}
      STRIPE_PRICE_TALENT_ANNUAL: ${{ secrets.STRIPE_PRICE_TALENT_ANNUAL }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check if PR is from fork
        id: fork_check
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.pull_request.head.repo.fork }}" = "true" ]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è PR is from fork - Supabase steps will be skipped"
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
          fi

      - name: Choose project ref by branch
        id: ref
        run: |
          if [ -z "${SUPABASE_PROJECT_ID:-}" ]; then
            echo "‚ùå SUPABASE_PROJECT_ID secret is not set"
            exit 1
          fi
          if [ "${GITHUB_REF##*/}" = "main" ]; then
            echo "ref=${SUPABASE_PROJECT_ID}" >> $GITHUB_OUTPUT
            echo "env=production" >> $GITHUB_OUTPUT
          else
            echo "ref=${SUPABASE_PROJECT_ID}" >> $GITHUB_OUTPUT
            echo "env=development" >> $GITHUB_OUTPUT
          fi
          echo "‚úÖ Using project ref: $(echo ${SUPABASE_PROJECT_ID} | cut -c1-4)‚Ä¶"

      - name: Verify environment variables
        run: |
          echo "Branch: ${GITHUB_REF##*/}"
          echo "Environment: ${{ steps.ref.outputs.env }}"
          echo "Project Ref prefix: $(echo '${{ steps.ref.outputs.ref }}' | cut -c1-4)‚Ä¶"
          node -e "console.log('SUPABASE_URL:', !!process.env.NEXT_PUBLIC_SUPABASE_URL, 'ANON_KEY:', !!process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY)"
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Build application
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          STRIPE_PRICE_TALENT_MONTHLY: ${{ secrets.STRIPE_PRICE_TALENT_MONTHLY }}
          STRIPE_PRICE_TALENT_ANNUAL: ${{ secrets.STRIPE_PRICE_TALENT_ANNUAL }}
        run: npm run build

      - name: Clear Supabase temp cache
        run: rm -rf supabase/.temp || true

      - name: Verify Supabase secrets are available
        if: steps.fork_check.outputs.is_fork != 'true'
        run: |
          if [ -z "${SUPABASE_ACCESS_TOKEN:-}" ]; then
            echo "‚ùå SUPABASE_ACCESS_TOKEN secret is not set"
            echo "üí° Make sure SUPABASE_ACCESS_TOKEN is set in GitHub Secrets"
            exit 1
          fi
          if [ -z "${{ steps.ref.outputs.ref }}" ]; then
            echo "‚ùå SUPABASE_PROJECT_ID secret is not set"
            echo "üí° Make sure SUPABASE_PROJECT_ID is set in GitHub Secrets"
            exit 1
          fi
          echo "‚úÖ Supabase secrets are available"
          echo "Project Ref prefix: $(echo '${{ steps.ref.outputs.ref }}' | cut -c1-4)‚Ä¶"

      - name: Debug token format (safe)
        if: steps.fork_check.outputs.is_fork != 'true'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          node -e "const t=process.env.SUPABASE_ACCESS_TOKEN||''; console.log('Token length:', t.length); console.log('Starts with:', t.slice(0,4)); console.log('Has spaces:', /\s/.test(t)); console.log('Has quotes:', /[\"']/.test(t));"
          if [ -z "${SUPABASE_ACCESS_TOKEN}" ]; then
            echo "‚ùå Token is empty!"
            exit 1
          fi
          if [ "${SUPABASE_ACCESS_TOKEN#sbp_}" = "${SUPABASE_ACCESS_TOKEN}" ]; then
            echo "‚ùå Token does not start with 'sbp_'"
            exit 1
          fi
          echo "‚úÖ Token format looks valid"

      - name: Setup Supabase CLI
        if: steps.fork_check.outputs.is_fork != 'true'
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project (branch-aware)
        if: steps.fork_check.outputs.is_fork != 'true'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ steps.ref.outputs.ref }}
        run: |
          echo "üîó Linking to Supabase project: $(echo '${{ steps.ref.outputs.ref }}' | cut -c1-4)‚Ä¶"
          supabase link --project-ref "$SUPABASE_PROJECT_REF"
          echo "‚úÖ Link successful"

      - name: Verify Supabase connection
        if: steps.fork_check.outputs.is_fork != 'true'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "üîç Verifying Supabase connection..."
          supabase projects list > /dev/null 2>&1 || {
            echo "‚ùå Failed to verify Supabase connection"
            echo "üí° Check that SUPABASE_ACCESS_TOKEN is valid and has access to the project"
            exit 1
          }
          echo "‚úÖ Connection verified"

      - name: Generate types from remote schema (branch-aware)
        if: steps.fork_check.outputs.is_fork != 'true'
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "üìù Generating types from remote schema..."
          supabase gen types --linked --lang=typescript --schema public > types/temp_schema_types.ts
          echo "‚úÖ Types generated"

      - name: Add banner to generated types
        if: steps.fork_check.outputs.is_fork != 'true'
        run: node scripts/prepend-autogen-banner.mjs types/temp_schema_types.ts

      - name: Normalize both files (strip BOM & normalize line endings)
        if: steps.fork_check.outputs.is_fork != 'true'
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import sys

          def normalize(src, dst):
            b = open(src, "rb").read()
            # strip UTF-8 BOM
            if b.startswith(b"\xef\xbb\xbf"):
              b = b[3:]
            # normalize ALL line ending variants to LF
            b = b.replace(b"\r\n", b"\n").replace(b"\r", b"\n")
            open(dst, "wb").write(b)

          normalize("types/temp_schema_types.ts", "types/_remote.normalized.ts")
          normalize("types/supabase.ts",          "types/_local.normalized.ts")
          PY

      - name: Compare generated types with committed types (filtering noise)
        if: steps.fork_check.outputs.is_fork != 'true'
        shell: bash
        run: |
          set -euo pipefail
          
          # Function to clean files by removing volatile __InternalSupabase block
          # and normalizing whitespace (trailing spaces, blank-only lines)
          clean() {
            sed -E '/__InternalSupabase: \{/,/^\s*\}/d' "$1" \
            | sed -E 's/[[:space:]]+$//' \
            | sed -E '/^[[:space:]]*$/d'
          }
          
          # Create cleaned versions for comparison
          clean types/_remote.normalized.ts > types/_remote.clean.ts
          clean types/_local.normalized.ts > types/_local.clean.ts
          
          if ! diff -u types/_remote.clean.ts types/_local.clean.ts; then
            echo ""
            echo "‚ùå ERROR: types/supabase.ts is out of sync with remote schema"
            echo ""
            echo "üîß To fix locally:"
            echo "   npm run types:regen:dev"
            echo ""
            echo "üìã Changes detected (excluding __InternalSupabase noise):"
            echo "   - Lines starting with '-' are in your local file but not in remote"
            echo "   - Lines starting with '+' are in remote but missing from your local file"
            echo ""
            echo "üåç Environment: ${{ steps.ref.outputs.env }}"
            echo "üîó Project Ref prefix: $(echo '${{ steps.ref.outputs.ref }}' | cut -c1-4)‚Ä¶"
            echo ""
            exit 1
          else
            echo "‚úÖ Types are in sync with remote schema (${{ steps.ref.outputs.env }})"
          fi

      - name: Verify schema & type hygiene (fast)
        if: steps.fork_check.outputs.is_fork != 'true'
        shell: pwsh
        run: ./scripts/verify-schema-sync.ps1 -SkipDbGeneration -EnforceBanner:$false -SoftFail

      - name: Skip message for fork PRs
        if: steps.fork_check.outputs.is_fork == 'true'
        run: |
          echo "‚ö†Ô∏è Skipping Supabase schema verification for fork PR"
          echo "üí° Fork PRs don't have access to repository secrets"
          echo "‚úÖ This is expected behavior - types will be verified when PR is merged"

      - name: Cleanup temp files
        if: always()
        run: rm -f types/_remote.normalized.ts types/_local.normalized.ts types/_remote.clean.ts types/_local.clean.ts types/temp_schema_types.ts 